# `point cloud optimization.py` 函式與流程詳解 (最新版)

本文件旨在詳細說明 `point cloud optimization.py` 腳本中各個 Python 函式的功能，並闡述當前版本程式碼的完整執行流程。

---

## 核心處理函式

### 1. `remove_outliers`
- **功能**: 移除點雲中距離主體較遠的「離群點」，是點雲清理的第一步。
- **演算法**: 結合**八叉樹密度**與**統計分析**，此方法對應於參考文件中提出的離群點移除演算法。
    1.  呼叫 `_get_octree_density_map` 取得每個點的局部密度 (`pn`)。
    2.  對每個點，計算它與其 K 個最近鄰居點的平均距離。
    3.  計算一個「離群機率 (`delta`)」，由「平均鄰居距離」除以「局部密度」得到。離群點通常有較大的鄰居距離和較低的密度，因此 `delta` 值會很高。
    4.  根據百分位數設定一個動態閾值，移除 `delta` 值高於閾值的點。
- **回傳**: 清理後的點雲物件及被保留點的索引。

### 2. `remove_confounding_points`
- **功能**: 平滑化點雲表面，並修正那些緊貼在表面但位置不對的「混淆點」(Confounding Points)。
- **演算法**: **局部平面擬合與投影**，對應參考文件中的混淆點移除方法。
    1.  對每一個點，找到其 K 個最近的鄰居點。
    2.  使用這些鄰居點（通過計算協方差矩陣的特徵向量）擬合出一個最優的局部平面。
    3.  將原始的點**投影**到這個擬合出的平面上，使其「歸位」。
- **目的**: 將偏離的點拉回到更符合其鄰域結構的位置，達到平滑化和修正輕微噪點的效果。

### 3. `fill_holes_bpa` (當前使用的方法)
- **功能**: 使用**滾球演算法 (Ball-Pivoting Algorithm, BPA)** 來填補孔洞。這是目前解決方案中，用於取代先前所有填補策略的最終、最穩健的方法。
- **演算法**:
    1.  **強制法向量計算與統一**: 無論輸入點雲是否已有法向量，都強制重新計算，並通過 `orient_normals_towards_camera_location` 將所有法向量統一朝向一個虛擬的外部視點。**這是解決「黑面」光照問題的關鍵步驟**。
    2.  **多半徑計算**: 基於點雲的平均點距，計算出一組由小到大的半徑列表（`radii`）。
    3.  **BPA 網格重建**: 調用 Open3D 的 `create_from_point_cloud_ball_pivoting`，使用這組半徑來重建三角網格。小半徑的球負責滾動並貼合化物體表面的精細細節，而大半徑的球則能滾過並「鋪平」較大的孔洞。
    4.  **網格清潔**: 對生成的網格進行基礎的清理，移除退化、重複或未被引用的頂點/面。
    5.  **點雲採樣**: 最後，從清潔後的網格上均勻採樣點，生成最終的、已填補孔洞的點雲。
- **優點**: BPA 在保留物體原始邊界和細節方面，通常比 Alpha-shape 和泊松重建的組合更為可靠，能有效避免在複雜結構上產生「跨接」和「內部假面」等嚴重錯誤。

---

## 輔助與評估函式

### `add_defects`
- **功能**: 在乾淨的點雲上模擬真實世界的瑕疵，以供測試演算法。
- **步驟**:
    1.  **增加噪點**: 疊加高斯噪點（模擬混淆點）並新增完全隨機的離群點。
    2.  **製造孔洞**: 採用「侵蝕型」方法，在隨機區域移除大部分點的同時保留一小部分，以模擬更真實、不規則的孔洞邊緣。

### `_get_octree_density_map`
- **功能**: 一個輔助函式，通過建立八叉樹結構來快速計算每個點所在的局部空間密度。

### `calculate_denoising_metrics`
- **功能**: 根據參考文件中的指標（Pd, Rd, F-score），評估 `remove_outliers` 步驟的去噪性能。
- **演算法**: 比較演算法移除的點與「真實噪點」，計算 **Precision (精度, Pd)**, **Recall (召回率, Rd)**, 和 **F1-score**。

---

## 程式主流程 (`main` 函式)

當前版本的執行流程已被大幅簡化，以反映 BPA 演算法的穩健性。

1.  **設定與載入**: 載入原始、乾淨的點雲資料 (`pcd_clean`)。
2.  **產生瑕疵**: 呼叫 `add_defects`，在點雲上加入噪點和侵蝕型孔洞，產生 `pcd_noisy`。
3.  **執行優化管線**:
    -   **步驟 1: 移除離群點**
        -   呼叫 `remove_outliers` 處理 `pcd_noisy`。
    -   **步驟 2: 移除混淆點 (平滑化)**
        -   對上一步的結果進行多輪 `remove_confounding_points` 操作，得到 `pcd_smoothed`。
    -   **步驟 3: 孔洞填補**
        -   呼叫 `fill_holes_bpa` 處理 `pcd_smoothed`，得到 `pcd_holes_filled`。
4.  **手動確認與可選的後處理**
    -   程式會暫停，並詢問您是否要對 BPA 的結果執行一次額外的清潔（去噪+平滑）。
5.  **最終視覺化**:
    -   顯示最終處理完成的點雲 (`pcd_final`)。

---

## 已棄用的舊方案

以下是在迭代過程中被 `fill_holes_bpa` 取代的舊方法，保留於此供參考。

- **`fill_holes_combined`**: 結合 Alpha-shape 和泊松重建的全局方法。對簡單、連續的物體效果很好，但面對複雜、多組件的點雲時，極易產生「跨接」和「內部假面」的問題。
- **`fill_holes_iteratively`**: 局部迭代填補方法。雖然能通過 DBSCAN 聚類避免跨接問題，但其依賴的 Delaunay 三角化在孔洞邊界不規則時不夠穩定，容易產生「飛濺」噪點，且孔洞填補不夠徹底。
