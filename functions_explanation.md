# `point cloud optimization.py` 函式與流程詳解 (最新版)

本文件旨在詳細說明 `point cloud optimization.py` 腳本中各個 Python 函式的功能，並闡述當前版本程式碼的完整執行流程。

---

## 核心處理函式

### 1. `remove_outliers`
- **功能**: 移除點雲中距離主體較遠的「離群點」，是點雲清理的第一步。
- **演算法**: 結合**八叉樹密度**與**統計分析**，此方法對應於參考文件中提出的離群點移除演算法。
    1.  呼叫 `_get_octree_density_map` 取得每個點的局部密度 (`pn`)。
    2.  對每個點，計算它與其 K 個最近鄰居點的平均距離。
    3.  計算一個「離群機率 (`delta`)」，由「平均鄰居距離」除以「局部密度」得到。離群點通常有較大的鄰居距離和較低的密度，因此 `delta` 值會很高。
    4.  根據百分位數設定一個動態閾值，移除 `delta` 值高於閾值的點。
- **回傳**: 清理後的點雲物件及被保留點的索引。

### 2. `remove_confounding_points`
- **功能**: 平滑化點雲表面，並修正那些緊貼在表面但位置不對的「混淆點」(Confounding Points)。
- **演算法**: **局部平面擬合與投影**，對應參考文件中的混淆點移除方法。
    1.  對每一個點，找到其 K 個最近的鄰居點。
    2.  使用這些鄰居點（通過計算協方差矩陣的特徵向量）擬合出一個最優的局部平面。
    3.  將原始的點**投影**到這個擬合出的平面上，使其「歸位」。
- **目的**: 將偏離的點拉回到更符合其鄰域結構的位置，達到平滑化和修正輕微噪點的效果。

### 3. 孔洞填補函式 (Hole Filling Functions)

腳本中包含多種孔洞填補的實現方法。

#### `fill_holes_combined` (當前使用的方法)
- **功能**: 結合兩種先進的重建技術來填補孔洞，是 `main` 函式中實際使用的方法。
- **演算法**:
    1.  呼叫 `fill_holes_local_adaptive_alpha` 產生一個基於 α-shape 的基礎網格。
    2.  呼叫 `fill_holes_poisson_enhanced` 產生一個更平滑、更完整的泊松重建網格。
    3.  將兩種方法的結果合併，並進行體素下採樣，以整合兩者的優點。
- **優點**: 這種組合方法既能較好地保持原始邊緣細節（α-shape 的優點），又能生成平滑且水密的表面（泊松重建的優點）。

#### `fill_holes` (參考文件中描述的方法)
- **功能**: 根據參考文件描述的「基於優先級的迭代填補」演算法來填補孔洞。
- **演算法**:
    1.  使用 α-shape 創建初始的三角網格。
    2.  計算每個三角形的面積，面積越大代表孔洞越大，優先級越高。
    3.  在面積最大的三角形的**重心 (Centroid)** 處插入一個新點。
    4.  對新插入的點進行局部平面投影，使其位置更平滑。
    5.  重複以上步驟，直到沒有面積超過閾值的三角形或達到最大迭代次數。
- **注意**: 此函式在目前的 `main` 流程中 **未被調用**。

##### **與參考文件的詳細比較**

| 步驟/特徵 (Feature/Step) | 參考文件 (`詳細步驟.pdf`) 中的方法 | 程式碼 (`fill_holes` 函式) 中的實現 |
| :--- | :--- | :--- |
| **1. 三角化方法** | 僅提及通用的「三角網格化演算法」。 | 明確使用 **Alpha-shape** (`create_from_point_cloud_alpha_shape`)。 |
| **2. 優先級計算** | 提及使用「海倫公式」(Heron's formula) 計算三角形面積 `si` 作為優先級。 | 使用向量叉積 (`np.cross`) 計算面積，結果等效於海倫公式，同樣以面積作為優先級。 |
| **3. 新點插入位置** | 在最大優先級的三角形的「重心」(center of gravity) 處插入新點。 | 完全一致，在面積最大的三角形的「質心」(centroid) 處插入新點。 |
| **4. 新點後處理** | **無提及**。文件中描述插入新點後直接進入下一次迭代。 | **有額外步驟**。在插入新點後，增加了一個「**精煉步驟 (Refinement Step)**」，將新點投影到其鄰域的局部擬合平面上，使其位置更平滑。 |
| **5. 迭代停止條件** | 描述為「直到破孔完全修復」。 | 1. 當找不到面積足夠大的三角形時停止。<br>2. 達到預設的**最大迭代次數** (`max_iterations`) 時停止。 |

**結論**: 程式碼中的 `fill_holes` 函式不僅忠實地實現了參考文件中的核心思想（基於面積優先級和重心插入），還額外增加了一個重要的**新點精煉步驟**，這使得填補的孔洞邊緣與周圍曲面能更平滑地融合。

#### `fill_holes_local_adaptive_alpha`
- **功能**: 使用 Alpha-shape 演算法從點雲生成三角網格，α 值會根據點的局部密度進行自適應調整。

#### `fill_holes_poisson_enhanced`
- **功能**: 使用泊松表面重建演算法，它能生成高質量的水密網格，特別適合填補大的孔洞。

---

## 輔助與評估函式

### `add_defects`
- **功能**: 在乾淨的點雲上模擬真實世界的瑕疵，以供測試演算法。
- **步驟**:
    1.  **增加噪點**: 疊加高斯噪點並新增隨機離群點。
    2.  **製造孔洞**: 隨機選取幾個區域並移除其中的點，形成孔洞。

### `_get_octree_density_map`
- **功能**: 一個輔助函式，通過建立八叉樹結構來快速計算每個點所在的局部空間密度。

### `calculate_chamfer_distance`
- **功能**: 計算兩個點雲之間的**倒角距離 (Chamfer Distance)**，用於定量評估處理後點雲與原始乾淨點雲的相似度。值越小代表相似度越高。

### `calculate_denoising_metrics`
- **功能**: 根據參考文件中的指標（Pd, Rd, F-score），評估 `remove_outliers` 步驟的去噪性能。
- **演算法**: 比較演算法移除的點與「真實噪點」，計算 **Precision (精度, Pd)**, **Recall (召回率, Rd)**, 和 **F1-score**。

---

## 程式主流程 (`main` 函式)

1.  **設定與載入**: 載入原始、乾淨的點雲資料 (`pcd_clean`)。
2.  **產生瑕疵**: 呼叫 `add_defects`，在點雲上加入噪點和孔洞，產生 `pcd_noisy`。並儲存結果。
3.  **執行優化管線**:
    -   **步驟 1: 移除離群點**
        -   呼叫 `remove_outliers` 處理 `pcd_noisy`，得到 `pcd_outliers_removed`。
        -   呼叫 `calculate_denoising_metrics` 評估去噪的 F1-score 等指標。
        -   儲存結果。
    -   **步驟 2: 移除混淆點 (平滑化)**
        -   對 `pcd_outliers_removed` 進行多輪 `remove_confounding_points` 操作，得到 `pcd_confounding_removed`。
        -   儲存結果。
    -   **步驟 3: 孔洞填補**
        -   呼叫 `fill_holes_combined` 處理 `pcd_confounding_removed`，得到最終的 `pcd_holes_filled`。
        -   儲存結果。
4.  **最終評估與視覺化**:
    -   呼叫 `calculate_chamfer_distance`，計算最終結果 `pcd_confounding_removed` 與原始點雲 `pcd_clean` 的相似度。
    -   在視窗中並排顯示 **原始點雲 (`pcd_clean`)**、**帶瑕疵點雲 (`pcd_noisy`)** 和 **最終處理完成的點雲 (`pcd_holes_filled`)**，以供直觀比較。